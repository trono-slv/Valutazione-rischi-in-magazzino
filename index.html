<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valutazione Rischi Magazzino - DVR Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass { 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { 
            background: rgba(255,255,255,0.2); 
            border-radius: 3px; 
        }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { 
            background: rgba(255,255,255,0.1); 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900/20 to-slate-900 min-h-screen text-white overflow-x-hidden">
    
    <!-- Service Worker per PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,d29ycmVycm9yKCk7').catch(() => {});
        }
    </script>

    <!-- Header Presentazione -->
    <header class="glass sticky top-0 z-50 backdrop-blur-xl shadow-2xl border-b-0">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="text-center mb-8">
                <h1 class="text-5xl md:text-6xl font-bold bg-gradient-to-r from-white to-purple-200 bg-clip-text text-transparent mb-4 animate-fade-in">
                    DVR Magazzino
                </h1>
                <p class="text-xl text-slate-300 max-w-2xl mx-auto mb-8">
                    Valutazione Completa dei Rischi Specifici per Magazzini e Logistica
                </p>
            </div>

            <!-- Presentazione Dott. Salvatore Trono -->
            <div class="glass p-8 rounded-3xl max-w-4xl mx-auto mb-8 animate-fade-in">
                <div class="text-center">
                    <div class="w-24 h-24 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full mx-auto mb-6 shadow-2xl"></div>
                    <h2 class="text-3xl font-bold text-white mb-4">Dott. Salvatore Trono</h2>
                    <p class="text-xl font-semibold text-purple-300 mb-2">Laureato in Servizi Giuridici per l'Impresa</p>
                    <p class="text-lg text-slate-300 mb-6">Esperto in Sicurezza sui Luoghi di Lavoro e Formatore Qualificato</p>
                    <p class="text-slate-400 italic max-w-2xl mx-auto">
                        "Professionalit√† e competenza al servizio della tua sicurezza. Oltre 15 anni di esperienza nella redazione di DVR e formazione specifica per magazzini e logistica."
                    </p>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="glass p-6 rounded-2xl bg-yellow-500/10 border border-yellow-500/30 animate-fade-in">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <p class="text-sm text-yellow-100 font-medium">
                        <strong>Disclaimer:</strong> I dati sono forniti gratuitamente dal Dott. Salvatore Trono. 
                        <strong>√à obbligatorio citare la fonte nei crediti e riferimenti.</strong> 
                        Non sostituisce consulenza professionale personalizzata.
                    </p>
                </div>
            </div>

            <!-- Pulsante Avvio -->
            <div class="text-center mt-12">
                <button onclick="startCourse()" class="glass px-12 py-6 rounded-3xl text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-2xl transform hover:scale-105 transition-all duration-300">
                    üöÄ Avvia Studio DVR Magazzino
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-12">
        <!-- Sidebar Navigazione -->
        <nav id="sidebar" class="fixed left-6 top-40 w-80 h-fit glass p-8 rounded-3xl shadow-2xl scrollbar-thin max-h-[70vh] overflow-y-auto hidden lg:block z-40">
            <h3 class="text-2xl font-bold mb-8 text-center bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">üìã Indice Lezioni</h3>
            
            <!-- Macro Aree (Lezioni Principali) -->
            <div id="toc" class="space-y-3">
                <!-- Verranno popolate da JS -->
            </div>
            
            <!-- Progresso -->
            <div class="mt-8 pt-8 border-t border-white/20">
                <div class="text-sm text-slate-400 mb-2">Progresso: <span id="progress">0%</span></div>
                <div class="w-full bg-white/10 rounded-full h-3">
                    <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Tools -->
            <div class="mt-6 space-y-3 pt-6 border-t border-white/20">
                <button onclick="exportPDF()" class="w-full glass p-3 rounded-xl hover:bg-white/20 transition-all flex items-center gap-3 text-sm">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 17.707a1 1 0 01-1.414 0L6 14l1.293-1.293a1 1 0 011.414 0L9 12.586V3a1 1 0 012 0v9.586l1.293-1.293a1 1 0 111.414 1.414l-3.293 3.293z"/><path d="M3 5a2 2 0 012-2h1a1 1 0 010 2H5v12h14V5h-1a1 1 0 110-2h1a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/></svg>
                    Esporta PDF Completo
                </button>
                <button onclick="toggleTheme()" class="w-full glass p-3 rounded-xl hover:bg-white/20 transition-all flex items-center gap-3 text-sm">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
                    <span id="themeBtn">üåô Modalit√† Scura</span>
                </button>
            </div>
        </nav>

        <!-- Contenuti Principali -->
        <div class="lg:ml-96 space-y-12">
            <!-- Presentazione Iniziale -->
            <section id="intro" class="glass p-12 rounded-3xl text-center animate-fade-in hidden">
                <h2 class="text-4xl font-bold mb-8">Benvenuto nel Corso DVR Magazzino</h2>
                <p class="text-xl text-slate-300 max-w-3xl mx-auto mb-12">
                    Scopri tutti i rischi specifici del magazzino con contenuti basati su D.Lgs. 81/08 e linee guida INAIL. 
                    Clicca sulle macro-aree nella sidebar per iniziare!
                </p>
                <div class="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <div class="glass p-6 rounded-2xl hover:scale-105 transition-all">
                        <div class="text-3xl mb-4">üìä</div>
                        <h3 class="font-bold text-xl mb-2">6 Macro Aree</h3>
                        <p class="text-slate-400">Analisi completa DVR</p>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:scale-105 transition-all">
                        <div class="text-3xl mb-4">‚úÖ</div>
                        <h3 class="font-bold text-xl mb-2">+50 Sotto-Rischi</h3>
                        <p class="text-slate-400">Contenuti dettagliati</p>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:scale-105 transition-all">
                        <div class="text-3xl mb-4">üìÑ</div>
                        <h3 class="font-bold text-xl mb-2">Esporta PDF</h3>
                        <p class="text-slate-400">Report professionale</p>
                    </div>
                </div>
            </section>

            <!-- Lezioni (Macro Aree) -->
            <div id="lessons-container" class="space-y-12 hidden">
                <!-- Verranno popolate dinamicamente da JS -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="glass mt-24 p-12 text-center border-t border-white/10">
        <p class="text-slate-400 mb-4">¬© 2026 DVR Magazzino - Creato dal <strong>Dott. Salvatore Trono</strong></p>
        <p class="text-xs text-slate-500">Dati gratuiti | Obbligatoria citazione fonte | Non sostituisce consulenza professionale</p>
    </footer>

    <!-- Script Principale -->
    <script>
        // Dati dal documento Word - Macro Aree e Sotto-Rischi
        const lessonsData = {
            1: {
                title: "Sovraccarico Biomeccanico",
                icon: "üí™",
                description: "Stress eccessivo su muscoli, articolazioni e scheletro causato dalla movimentazione manuale di carichi e dalle posture incongrue",
                subrisks: {
                    "distorsioni": {
                        title: "1. Distorsioni Articolari",
                        content: `Le distorsioni articolari derivano principalmente da movimenti bruschi e scorretti durante la movimentazione manuale di carichi mal bilanciati o voluminosi, tipici delle operazioni di picking, stoccaggio e prelievo merci in magazzino. Fattori causali specifici includono:

**Sollevamento di carichi asimmetrici** senza adeguata presa bilaterale.
**Torsioni del tronco** durante la retromarcia con transpallet o muletti in spazi ristretti.
**Afferraggio di pallet instabili** o merci scivolose, con accelerazioni improvvise.
**Superfici irregolari** o ostacoli che provocano passi falsi durante il trasporto manuale.

### Danni
Le distorsioni articolari provocano lesioni legamentose e capsulari con edema locale, dolore acuto, limitazione funzionale immediata e possibile instabilit√† cronica dell'articolazione interessata (tipicamente caviglia, ginocchio, polso). Conseguenze gravi includono:

- **Infortuni acuti**: Rottura parziale/completa di legamenti (es. legamento collaterale mediale del ginocchio), con tempi di recupero 4-8 settimane.
- **Patologie croniche**: Instabilit√† recidivante, artrosi post-traumatica, riduzione della capacit√† lavorativa permanente (**INAIL: invalidit√† media 5-15%**).
- **Complicanze sistemiche**: In casi gravi, trombosi venosa profonda o sindrome compartimentale.

### Metodi di Prevenzione e Protezione
**Prevenzione (gerarchia: eliminazione > sostituzione > controlli ingegneristici):**
- **Analisi MMC avanzata**: Metodo OCRA per arti superiori + NIOSH per colonna; soglia azione OCRA <2,8 (Allegato XXXIV D.Lgs. 81/2008).
- **Redesign workplace**: Tappetini antaffaticanti (spessore 15-20mm), sgabelli regolabili (60-80cm), muletti con sospensioni pneumatiche.
- **Organizzazione**: Pausa micro (5min/ora), rotazione mansioni (max 2h MMC consecutiva), automazione picking (AGV).

**Protezione (DPI + misure complementari):**
- **DPI certificati**: Imbracature lombari (UNI EN 613), ginocchiere gel (UNI EN 14404 cl. 2), scarpe SRA con plantari.
- **Sorveglianza sanitaria**: Protocollo INAIL (Art. 41): visita preassuntiva + semestrale >35 anni, test algometrici, RMN/ecografia.
- **Formazione**: 16h modulo DMS (Accordo Stato-Regioni 2011), training posture corrette ("arco di forza").

**Fonti**: D.Lgs. 81/2008 (Allegati XXXIII-XXXIV); INAIL "Disturbi Muscoloscheletrici" (2020); UNI EN ISO 11228-3.`
                    },
                    "erne": {
                        title: "3. Ernie Discali",
                        content: `### Cause
**Ernia lombare (L4-L5/L5-S1)**: Sciatalgia, deficit forza tibiale, ipoestesia L5/S1.
**Ernia cervicale (C5-C6/C6-C7)**: Cervicobrachialgia, deficit forza deltoide/bicipite.
**Ernia toracica rara (T8-T12)**: Dolore scapolare toracico.

**Complicanze**: Asimmetria cronica, atrofia muscolare, invalidit√† INAIL 20-50%, recidiva 10-15% post-chirurgia.

### Metodi di Prevenzione e Protezione
**Prevenzione (Allegato XXXIII D.Lgs. 81/2008):**
- **Valutazione NIOSH**: Lifting Index (LI) <1; RWL = LC √ó HM √ó VM √ó DM √ó AM √ó FM.
- **Controlli ingegneristici**: Pedane regolabili (0-120cm), muletti ergonomici.
- **Organizzazione**: Teamlifting >25kg, rotazione postazioni.

**Protezione:**
- **DPI**: Tutori lombari (UNI EN 613), scarpe S3 (shock absorption >20J).
- **Sorveglianza**: Visita annuale, RMN lombare/cervicale, test Sch√∂ber, EMG.
- **Formazione**: 16h MMC, tecnica "powerlift".

**Fonti**: D.Lgs. 81/2008; INAIL; ISO 11228.`
                    },
                    "movimenti": {
                        title: "Movimenti Ripetitivi",
                        content: `### Cause
Stress biomeccanico da operazioni ripetute (picking veloce >1000-2000 cicli/giorno).

**Danni**: DMS (STC, tendiniti, cervicalgie) - prevalenza 40-60%.

### Prevenzione
**OCRA <3,5**, micro-pause 5-10%, scanner vocali, rotazione mansioni.

**Fonti**: Allegato XXXIV D.Lgs. 81/2008; INAIL OCRA.`
                    },
                    "posture": {
                        title: "Posture Incongrue",
                        content: `### Cause
Tronco flesso >30¬∞, spazi ristretti, altezze scaffali inadeguate.

**Danni**: Lombalgie, ernie, stiramenti.

### Prevenzione
**NIOSH/MAPO**: Lifting Index <1, meccanizzazione, team lifting.

**Fonti**: Titolo VI D.Lgs. 81/2008.`
                    }
                }
            },
            2: {
                title: "Rischi Traumatici e da Incidenti",
                icon: "‚ö†Ô∏è",
                description: "Cadute, collisioni, schiacciamenti e investimenti",
                subrisks: {
                    "caduta-materiali": {
                        title: "1. Caduta di Materiali/Oggetti",
                        content: `**Cause**: Merci impilate scorrettamente, senza contenimento.

**Danni**: Schiacciamento, traumi gravi.

**Prevenzione**: Scaffalature certificate, stoccaggio stabile, formazione.

**Fonti**: D.Lgs. 81/2008 Allegato VI.`
                    },
                    "cadute-altezza": {
                        title: "2. Cadute da Altezza",
                        content: `**Cause**: Scale, muletti, elevatori.

**Prevenzione**: Imbracature, parapetti, patentino muletti.`
                    },
                    "scivolamenti": {
                        title: "3. Cadute e Scivolamenti",
                        content: `**Cause**: Liquidi pavimento, ostacoli.

**Prevenzione**: Pavimenti antiscivolo, segnaletica, DPI S3.`
                    },
                    "collisioni": {
                        title: "4. Collisioni con Oggetti in Movimento",
                        content: `**Cause**: Transpallet, carriole, mancanza segnaletica.

**Prevenzione**: Vie separate, velocit√† ridotta, visibilit√†.`
                    },
                    "ribaltamenti": {
                        title: "5. Collisioni e Ribaltamenti Carrelli",
                        content: `**Cause**: Mancanza patentino, manovre scorrette.

**Danni**: Mortalit√† 30-50% ribaltamenti >1,5m.

**Prevenzione**: Patentino 12h, manutenzione, pavimentazione.`
                    },
                    "intrappolamento": {
                        title: "6. Intrappolamento",
                        content: `**Prevenzione**: Procedure sicurezza, barriere.`
                    },
                    "investimento": {
                        title: "7. Investimento da Veicoli",
                        content: `**Prevenzione**: Segnaletica, percorsi separati.`
                    },
                    "schiacciamento": {
                        title: "8. Schiacciamento Carichi Pesanti",
                        content: `**Prevenzione**: Controlli strutturali, teamlifting.`
                    }
                }
            },
            3: {
                title: "Rischi Chimici e Biologici",
                icon: "üß™",
                description: "Sostanze nocive, dermatiti, agenti patogeni",
                subrisks: {
                    "contatto-nocive": {
                        title: "1. Contatto Sostanze Nocive",
                        content: `**Cause**: Detergenti, solventi, acidi.

**Prevenzione**: DPI UNI EN 374, ventilazione, docce emergenza.

**Fonti**: Tit. IX D.Lgs. 81/2008.`
                    },
                    "dermatiti": {
                        title: "2. Dermatiti",
                        content: `**Prevenzione**: Guanti specifici, creme barriera.`
                    },
                    "batteri": {
                        title: "3. Batteri, Muffe, Patogeni",
                        content: `**Prevenzione**: FFP2/FFP3, derattizzazione.`
                    },
                    "inalazione": {
                        title: "4. Inalazione Prodotti Chimici",
                        content: `**Prevenzione**: Maschere ABEK, aspirazione.`
                    },
                    "ingestione": {
                        title: "5. Ingestione Chimici",
                        content: `**Prevenzione**: Zone pranzo separate.`
                    },
                    "gastrointestinali": {
                        title: "6. Patologie Gastrointestinali",
                        content: `**Prevenzione**: Igiene, sorveglianza.`
                    }
                }
            },
            4: {
                title: "Rischi Ambientali e Microclimatici",
                icon: "üå°Ô∏è",
                description: "Incendi, stress termico, sbalzi temperatura",
                subrisks: {
                    "incendio": {
                        title: "1. Incendio",
                        content: `**Cause**: Merci infiammabili, muletti, stoccaggio errato.

**Prevenzione**: ATEX, sprinkler, D.M. 10/03/1998.

**Fonti**: D.Lgs. 81/2008 Tit. I.`
                    },
                    "stress-termico": {
                        title: "2. Stress Termico",
                        content: `**Prevenzione**: WBGT <26¬∞C, pause idratazione, DPI termoregolanti.`
                    }
                }
            },
            5: {
                title: "Rischi Posturali e da Movimentazione",
                icon: "ü¶¥",
                description: "MMC, posture incongrue, ripetitivit√†",
                subrisks: {
                    "mmc": {
                        title: "Movimentazione Manuale Carichi",
                        content: `**NIOSH**: LI <1, max 25kg uomo/15kg donna.

**Prevenzione**: Ausili meccanici, formazione powerlift.`
                    }
                }
            },
            6: {
                title: "Rischi Psicosociali e Notturno",
                icon: "üß†",
                description: "Stress, sonnolenza, disturbi sonno",
                subrisks: {
                    "sonno": {
                        title: "1. Disturbi del Sonno",
                        content: `**Cause**: Desincronizzazione circadiana.

**Prevenzione**: Illuminazione >500lux, rotazione turni.`
                    },
                    "sonnolenza": {
                        title: "3. Sonnolenza Lavoro",
                        content: `**Rischio**: Infortuni +300% 2-5 AM.`
                    },
                    "stress": {
                        title: "4. Stress Psicofisico",
                        content: `**Prevenzione**: DVR psicosociali (Cass. 14799/2025).`
                    }
                }
            }
        }
    };

    // Stato App
    let currentLesson = null;
    let progress = JSON.parse(localStorage.getItem('dvrProgress')) || {};
    let theme = localStorage.getItem('dvrTheme') || 'dark';

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add(theme);
        initProgress();
        buildTOC();
        updateProgress();
    });

    function startCourse() {
        document.getElementById('intro').classList.remove('hidden');
        document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('lessons-container').classList.remove('hidden');
        document.querySelector('header').classList.add('hidden');
        window.scrollTo(0, 0);
    }

    function buildTOC() {
        const toc = document.getElementById('toc');
        Object.entries(lessonsData).forEach(([id, lesson]) => {
            const div = document.createElement('div');
            div.className = 'group';
            div.innerHTML = `
                <button onclick="loadLesson(${id})" 
                        class="w-full text-left p-4 rounded-2xl hover:bg-white/20 transition-all flex items-center gap-3 font-semibold ${progress[id] ? 'bg-green-500/20 border border-green-500/50' : ''}">
                    <span class="text-2xl">${lesson.icon}</span>
                    <div>
                        <div class="text-white group-hover:text-purple-300">${lesson.title}</div>
                        <div class="text-sm text-slate-400">${lesson.description}</div>
                    </div>
                    ${progress[id] ? '<div class="ml-auto text-green-400">‚úÖ</div>' : ''}
                </button>
            `;
            toc.appendChild(div);
        });
    }

    function loadLesson(id) {
        currentLesson = id;
        const lesson = lessonsData[id];
        const container = document.getElementById('lessons-container');
        
        // Highlight sidebar
        document.querySelectorAll('#toc button').forEach((btn, i) => {
            btn.classList.toggle('ring-4', i+1 == id);
            btn.classList.toggle('ring-purple-500/50', i+1 == id);
        });

        // Contenuto lezione
        let html = `
            <section id="lesson-${id}" class="glass p-12 rounded-3xl animate-slide-down fade-in">
                <div class="flex items-center gap-6 mb-12">
                    <div class="text-6xl">${lesson.icon}</div>
                    <div>
                        <h2 class="text-5xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">${lesson.title}</h2>
                        <p class="text-xl text-slate-300 mt-2">${lesson.description}</p>
                    </div>
                </div>
        `;

        // Sotto-Rischi
        html += '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">';
        Object.entries(lesson.subrisks).forEach(([key, sub]) => {
            const completed = progress[id]?.[key];
            html += `
                <div class="glass p-6 rounded-2xl hover:scale-105 transition-all cursor-pointer group ${completed ? 'ring-2 ring-green-500/30 bg-green-500/10' : ''}" 
                     onclick="loadSubrisk(${id}, '${key}')" 
                     aria-label="${sub.title}">
                    <h4 class="font-bold text-xl mb-3 group-hover:text-purple-300 transition-colors">${completed ? '‚úÖ ' : ''}${sub.title}</h4>
                    <p class="text-slate-400 text-sm line-clamp-3 group-hover:line-clamp-none">${sub.content.split('\n')}</p>
                </div>
            `;
        });
        html += '</div>';

        // Checklist Completamento
        html += `
                <div class="glass p-8 rounded-2xl">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">üìã Checklist Completamento</h3>
                    <div class="grid md:grid-cols-2 gap-4">
        `;
        
        let checklistCount = 0;
        Object.keys(lesson.subrisks).forEach(key => {
            const completed = progress[id]?.[key];
            html += `
                <label class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 transition-all cursor-pointer ${completed ? 'text-green-400 bg-green-500/10 border border-green-500/30' : ''}">
                    <input type="checkbox" ${completed ? 'checked' : ''} onchange="toggleSubrisk(${id}, '${key}')" class="w-5 h-5 rounded text-purple-500 focus:ring-purple-500">
                    <span>${lesson.subrisks[key].title}</span>
                </label>
            `;
            checklistCount++;
        });
        
        html += `
                    </div>
                    <div class="mt-8 pt-6 border-t border-white/20 text-center">
                        <button onclick="completeLesson(${id})" 
                                class="px-8 py-4 rounded-2xl font-bold bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 shadow-xl transform hover:scale-105 transition-all ${Object.keys(lesson.subrisks).every(key => progress[id]?.[key]) ? '' : 'opacity-50 cursor-not-allowed'}">
                            ${Object.keys(progress[id] || {}).length === checklistCount ? 'üéâ Lezione Completata!' : `Completa ${checklistCount - Object.keys(progress[id] || {}).length} elementi`}
                        </button>
                    </div>
                </div>
            </section>
        `;

        container.innerHTML = html;
    }

    function loadSubrisk(lessonId, subriskId) {
        const sub = lessonsData[lessonId].subrisks[subriskId];
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in';
        modal.innerHTML = `
            <div class="glass max-w-4xl max-h-[90vh] overflow-y-auto scrollbar-thin p-8 rounded-3xl w-full mx-4">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-3xl font-bold">${sub.title}</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-2xl hover:text-red-400">&times;</button>
                </div>
                <div class="prose prose-invert max-w-none leading-relaxed text-slate-200">${sub.content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>
                <div class="mt-8 pt-6 border-t border-white/20 flex gap-4">
                    <button onclick="toggleSubrisk(${lessonId}, '${subriskId}'); this.parentElement.parentElement.parentElement.remove();" 
                            class="flex-1 px-6 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-xl">
                        ‚úÖ Segna come Completato
                    </button>
                    <button onclick="exportSubrisk(${lessonId}, '${subriskId}')" 
                            class="flex-1 px-6 py-3 rounded-xl font-semibold glass hover:bg-white/20">
                        üìÑ Esporta PDF
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function toggleSubrisk(lessonId, subriskId) {
        if (!progress[lessonId]) progress[lessonId] = {};
        progress[lessonId][subriskId] = !progress[lessonId][subriskId];
        localStorage.setItem('dvrProgress', JSON.stringify(progress));
        updateProgress();
        loadLesson(lessonId);
    }

    function completeLesson(id) {
        if (Object.keys(lessonsData[id].subrisks).every(key => progress[id]?.[key])) {
            alert('üéâ Lezione gi√† completata!');
            return;
        }
        Object.keys(lessonsData[id].subrisks).forEach(key => {
            if (!progress[id]?.[key]) toggleSubrisk(id, key);
        });
    }

    function initProgress() {
        Object.keys(lessonsData).forEach(id => {
            if (!progress[id]) progress[id] = {};
        });
        localStorage.setItem('dvrProgress', JSON.stringify(progress));
    }

    function updateProgress() {
        const total = Object.keys(lessonsData).reduce((acc, id) => acc + Object.keys(lessonsData[id].subrisks).length, 0);
        const completed = Object.values(progress).reduce((acc, lesson) => acc + Object.keys(lesson || {}).length, 0);
        const pct = Math.round((completed / total) * 100);
        
        document.getElementById('progress').textContent = `${pct}%`;
        document.getElementById('progressBar').style.width = `${pct}%`;
    }

    function toggleTheme() {
        document.body.classList.toggle('dark');
        theme = document.body.classList.contains('dark') ? 'dark' : 'light';
        localStorage.setItem('dvrTheme', theme);
        document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è Modalit√† Chiara' : 'üåô Modalit√† Scura';
    }

    // Esportazioni (simulazione - in produzione usa html2canvas + jsPDF)
    function exportPDF() {
        const content = document.getElementById('lessons-container').innerHTML;
        alert('üìÑ PDF esportato! (Simulazione - In produzione: html2canvas + jsPDF)\n\nContenuti completi salvati localmente.');
        console.log('Esporta:', content);
    }

    function exportSubrisk(lessonId, subriskId) {
        alert('üìÑ Sotto-rischio esportato!');
    }

    // Responsive Sidebar Mobile
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('translate-x-[-100%]');
    }
    </script>
</body>
</html>
